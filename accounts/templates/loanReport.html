{% extends 'header.html' %} {% load static %} {% block body %}

    <h5 class="text-center text-success mt-3" id = "key">{{loanData.title}}- ₹{{loanData.amount}}</h5>



  <form class="row g-3 justify-content-center m-3" action="/addEMI/{{loanData.id}}" method="post">
    {% csrf_token %}
    <div class="col-md-3 col-10">
      <input
      type="datetime-local"
      class="form-control"
      name="paid_on"
      placeholder="paid_on"
      id="paid_on"
      required
    />    
</div>
    <div class="col-md-3 col-10">
      <input
      type="number"
      class="form-control"
      name="amount"
      placeholder="Amount"
      id="amount"
      value = {% widthratio emiData.0.amount 1 -1 %}
      aria-describedby="emailHelp"
      required
    />    
</div>
    <div class="col-md-3 col-10">
        <input
        type="text"
        class="form-control"
        name="note"
        placeholder="Note"
        id="note"
        value = "{{emiData.0.note}}"
        aria-describedby="emailHelp"
      />
    </div>
    <div class="col-md-2 col-5">
        <button
        type="submit"
        {% comment %} style="background-color: #2b6b32; border: none" {% endcomment %}
        class="btn btn-success"
      >
        Pay EMI
      </button>    
    
    </div>
    <div class="col-md-1 col-5">
      <button type="button" onclick="generateCSV()" class="btn btn-success form-control"><i class="fa-solid fa-file-csv"></i></button>
    </div>
  </form> 




<div class="row mx-2 table-responsive">
  <table id ='myTable' class="table">
    <thead>
      <tr>
      <th scope="col"> <a href="/loanHome/" class="btn btn-secondary" style="background-color:rgb(77, 168, 104);"><i class="fa-solid fa-square-poll-horizontal"></i></a>
        </th>
        <th scope="col">Loan</th>
        <th scope="col">Amount</th>
        <th scope="col">Paid_On</th>
        <th scope="col">Detail</th>
        <th scope="col"></th>
        
       
      </tr>
    </thead>
    <tbody>
      
      {% if emiData %} {% for i in emiData %}
      <tr>
        <td scope="row">{{forloop.counter}}</td>
        <td>{{i.loan}}</td>
        <td>{{i.amount}}</td>
        <td>{{i.paid_on}}</td>
        <td>{{i.note}}</td>
        <td><a href={% url 'deleteEmi' i.id %}><i class="fa-solid text-danger fa-trash"></i></a></td>
        
      </tr>
      {% endfor %}{% else %}
      <td colspan="8" class="text-center">No Records found</td>
      {% endif %}
    </tbody>
    <tfoot>
      <tr >
        <td class="text-center border-0" colspan="2"><b>Total Remaining<b></td>
        <td class=" border-0"><b>₹{{total}}</b></td>
        <td class=" border-0" colspan="2"></td>
      </tr>
    </tfoot>
  </table>
</div>


{% endblock body %}

{% block script %}
<script>
  function generateCSV() {
    var table = document.getElementById("myTable");
    var csvContent = "data:text/csv;charset=utf-8,";
    var cont = document.getElementById("key").textContent.split('-');
    console.log(cont)
    // Extract the table headers
    var headers = table.getElementsByTagName("th");
    var headerValues = [];
    for (var i = 0; i < headers.length; i++) {
      headerValues.push(headers[i].textContent);
    }
    csvContent += '"' + headerValues.join('","') + '"\r\n';
  
    // Extract the table data
    var rows = table.getElementsByTagName("tr");
    for (var i = 0; i < rows.length; i++) {
      var cells = rows[i].getElementsByTagName("td");
      var rowValues = [];
      
      // Extract cell values
      for (var j = 0; j < cells.length; j++) {
        // Wrap date values in double quotes
        if (j === 2) {
          rowValues.push('"' + cells[j].textContent + '"');
        } else {
          rowValues.push(cells[j].textContent);
        }
      }
  
      // Format the row as CSV and add to the content
      csvContent += rowValues.join(",") + "\r\n";
    }
  
    // Create a download link for the CSV file
    var encodedUri = encodeURI(csvContent);
    var link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${cont[0]}.csv`);
    document.body.appendChild(link);
  
    // Trigger the link to start the download
    link.click();
  }

</script>
<script>
  // Get the current date and time in ISO format (YYYY-MM-DDTHH:MM)
  var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
  var currentDatetime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, 16);
  // Set the value of the input field to the current date and time
  document.getElementById("paid_on").value = currentDatetime;
</script>
{% endblock script %}
